# 撤销会员功能文档

## 功能概述

管理员可以通过"撤销会员"功能取消用户的会员权限。这个功能集成在现有的管理员面板中，保持了与其他管理功能一致的用户体验。

## 使用流程

### 1. 进入撤销菜单
- 管理员在"管理员控制面板"中点击"撤销会员"按钮
- 系统将管理员状态设置为 `waiting_revoke_user`
- 显示输入提示界面（5分钟超时）

### 2. 输入目标用户
支持两种输入格式：
- **用户ID**: 纯数字（如 `123456789`）
- **用户名**: 带或不带@符号（如 `@username` 或 `username`）

### 3. 确认用户信息
系统会显示：
- 用户昵称
- 用户ID
- 用户名
- 当前会员等级
- 会员到期时间

管理员可以：
- 点击"✅ 确认撤销"继续
- 点击"❌ 取消"放弃操作

### 4. 执行撤销
- 系统从数据库删除会员记录
- 显示撤销成功信息
- 尝试通知目标用户（会员权限已被撤销）

### 5. 后续操作
管理员可以：
- 点击"🔄 继续撤销"处理其他用户
- 点击"🔙 返回管理面板"返回主界面

## 技术实现

### 数据库层
```python
def revoke_membership(self, user_id: int) -> bool:
    """撤销用户会员
    
    Args:
        user_id: 要撤销会员的用户ID
    
    Returns:
        bool: True 如果删除了记录，False 如果没有记录被删除
    """
```

- SQL: `DELETE FROM memberships WHERE user_id = ?`
- 返回值基于 `rowcount`（删除的行数）

### UI流程
1. `handle_admin_revoke_menu` - 显示输入界面
2. `handle_revoke_user_input` - 处理用户输入，显示确认界面
3. `handle_admin_revoke_confirm` - 执行撤销操作
4. `handle_admin_revoke_cancel` - 取消操作

### 回调路由
- `admin_revoke_menu` - 进入撤销菜单
- `admin_revoke_confirm_{user_id}` - 确认撤销指定用户
- `admin_revoke_cancel` - 取消撤销操作

### 文本处理
在 `handle_text()` 中处理 `waiting_revoke_user` 状态：
```python
elif user_status == "waiting_revoke_user":
    self.handle_revoke_user_input(update, user_id, text)
    return
```

## 用户反馈

### 成功场景
```
✅ 撤销成功！

📋 撤销信息
• 目标用户: 张三
• 用户ID: 123456789
• 原会员等级: 会员
• 原到期时间: 2025-11-22 10:00:00

已成功撤销该用户的会员权限。
```

### 失败场景
```
❌ 未找到该用户

未找到该用户，请确认对方已与机器人对话入库
```

```
❌ 撤销失败

该用户可能没有会员权限，或撤销操作失败。
```

## 权限控制

- 仅管理员可以访问此功能
- 使用 `db.is_admin(user_id)` 进行权限检查
- 所有回调和处理器都包含权限验证

## 数据一致性

- 撤销操作使用事务确保原子性
- 删除操作只影响 `memberships` 表
- 不影响 `users` 表中的用户基本信息
- 用户可以重新获得会员权限（通过卡密或人工开通）

## 通知机制

### 目标用户通知
撤销成功后，系统尝试向目标用户发送通知：
```
⚠️ 会员权限已被撤销

您的会员权限已被管理员撤销。

如有疑问，请联系管理员。
```

- 使用 try-except 包裹，失败不影响撤销操作
- 如果用户屏蔽了机器人，通知会静默失败

## 错误处理

### 输入验证
- 空输入：提示重新输入
- 无效用户ID：提示用户不存在
- 未找到用户名：提示用户未与机器人交互

### 超时处理
- 5分钟内未输入：自动清除状态
- 超时后输入：不会触发处理器

### 数据库错误
- 捕获所有异常
- 打印错误日志
- 返回 False 表示失败

## 集成测试

### 单元测试
运行 `test_revoke_membership.py` 进行基础功能测试：
```bash
python3 test_revoke_membership.py
```

测试内容：
- 数据库操作（插入、查询、删除）
- `revoke_membership` 方法
- 边界条件（不存在的用户）

### 验证脚本
运行 `verify_revoke_feature.py` 验证代码完整性：
```bash
python3 verify_revoke_feature.py
```

验证内容：
- 代码实现完整性（13项检查）
- 系统集成一致性
- 需求符合性（11项需求）

## 与现有功能的关系

### 相似功能
- **人工开通**: 添加/延长会员
- **撤销会员**: 删除会员（新增）

### 共享组件
- `get_user_by_username` - 用户名查找
- `get_user_membership_info` - 会员信息查询
- `check_membership` - 会员状态检查
- `is_admin` - 权限检查

### UI一致性
- 使用相同的按钮样式
- 保持统一的中文UI
- 遵循相同的超时机制（5分钟）
- 统一的错误提示格式

## 安全考虑

1. **权限验证**: 所有入口都检查管理员权限
2. **数据隔离**: 不影响其他用户数据
3. **操作可逆**: 可以重新授予会员权限
4. **审计日志**: 操作记录在用户状态中
5. **通知机制**: 用户得到及时通知

## 未来扩展

可能的功能增强：
- [ ] 添加撤销原因记录
- [ ] 保存撤销历史（审计日志）
- [ ] 批量撤销功能
- [ ] 临时禁用（而非完全删除）
- [ ] 撤销确认邮件/消息模板

## 代码统计

- 新增代码行数: ~187行
- 新增方法: 4个
- 新增回调: 3个
- 中文UI文本: 14处
- 数据库修改: 1个方法（无表结构变更）

## 维护说明

### 修改建议
如需修改功能，请保持：
1. 管理员权限检查
2. 用户状态管理
3. 超时机制
4. 通知机制
5. 错误处理

### 问题排查
如遇问题，检查：
1. 数据库连接是否正常
2. 用户是否在数据库中
3. 管理员权限是否有效
4. 回调数据格式是否正确
5. 日志输出中的错误信息

## 相关文件

- `TGapibot.py` - 主要实现文件
- `test_revoke_membership.py` - 单元测试
- `verify_revoke_feature.py` - 验证脚本
- `README_REVOKE_MEMBERSHIP.md` - 本文档
