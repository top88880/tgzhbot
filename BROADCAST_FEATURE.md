# 📢 群发通知功能使用指南

## 功能概述

群发通知功能允许管理员向选定的用户群体发送富文本消息，支持**单图+文本(HTML)**、自定义按钮、实时进度显示和完整的历史记录跟踪。

## 主要特性

### ✨ 核心功能
- **HTML格式支持**：粗体、斜体、链接、代码等
- **媒体支持**：支持单张图片（作为消息配图）
- **自定义按钮**：URL按钮和回调按钮（最多4个）
- **智能节流**：批量发送（每批25人），延迟0.8-1.2秒
- **实时进度**：显示已处理/总数、成功/失败、速度、预计时间
- **多目标支持**：全部用户、仅会员、活跃用户、新用户
- **完整历史**：记录每次广播的详细信息和成功率
- **中文界面**：全中文两列仪表板UI

### 🔒 权限要求
- 仅管理员可以访问此功能
- 管理员通过配置文件（ADMIN_IDS）或数据库设置

## 使用流程

### 1. 进入广播菜单

1. 发送 `/start` 命令启动机器人
2. 点击 `👑 管理员面板`
3. 点击 `📢 群发通知`
4. 点击 `📝 创建群发`

### 2. 使用新版仪表板

创建群发后，会看到**消息广播 · 指南**仪表板，采用两列布局：

```
消息广播 · 指南

支持 单图+文本(HTML) 模式，自定义按钮，智能节流发送。

媒体 ❗未设置
文本 ❗未填写
按钮 ❗未设置

⏰ 5分钟内未操作将自动取消

[媒体] [👀 查看]
[文本] [👀 查看]
[按钮] [👀 查看]
[📱 完整预览]
[🔙 返回] [➡️ 下一步]
```

### 3. 配置广播内容

#### 步骤 1：添加媒体（可选）

1. 点击右侧**媒体**对应的按钮
2. 发送一张图片：
   - 直接粘贴截图
   - 从相册选择照片
   - 以文档形式发送（需为image/*类型）
3. 图片会自动保存，返回仪表板
4. 点击 **👀 查看** 可预览当前图片
5. 不想要媒体？点击 **🗑️ 清空媒体**

**注意：**
- 仅支持单张图片
- 图片会作为消息配图发送
- 有图片时文本会作为caption（最多1024字符）

#### 步骤 2：输入文本（必填）

1. 点击右侧**文本**对应的按钮
2. 输入群发文本，支持HTML格式：
   - `<b>粗体</b>`
   - `<i>斜体</i>`
   - `<a href="URL">链接</a>`
   - `<code>代码</code>`
3. 文本保存后返回仪表板
4. 点击 **👀 查看** 可预览当前文本

**示例：**
```html
<b>🎉 新功能上线！</b>

我们为您带来了全新功能：
• <b>账号分类</b> - 智能分类管理
• <b>批量操作</b> - 提高效率

<i>立即体验新功能！</i>
```

#### 步骤 3：添加按钮（可选）

1. 点击右侧**按钮**对应的按钮
2. 每行一个按钮，最多4个：
   - **URL按钮**：`文本|https://example.com`
   - **回调按钮**：`文本|callback:点击提示`
3. 按钮保存后返回仪表板
4. 点击 **👀 查看** 可查看当前按钮列表
5. 点击 **🗑️ 清空按钮** 可删除所有按钮

**示例：**
```
官网|https://telegram.org
查看详情|https://example.com/info
感谢关注|callback:感谢查看～
```

### 4. 预览和调整

在仪表板上：
- 状态实时更新（✅ 已完成 / ❗未设置）
- 点击 **📱 完整预览** 查看最终效果
- 预览会按实际发送的样式展示（含图片、按钮）
- 点击 **🔙 返回** 回到广播菜单

### 5. 选择目标用户

完成文本输入后，**➡️ 下一步**按钮才会生效。点击后选择目标：

| 选项 | 描述 | 筛选条件 |
|------|------|----------|
| 👥 全部用户 | 所有注册用户 | 无限制 |
| 💎 仅会员 | 有效会员用户 | 会员未过期 |
| 🔥 活跃用户(7天) | 近期活跃用户 | 7天内有活动 |
| 🆕 新用户(7天) | 新注册用户 | 7天内注册 |

系统会显示每个选项的用户数量。

### 6. 确认发送

选择目标后会显示预览信息：
- 目标群体和人数
- 是否含图片
- 内容预览
- 按钮列表
- 预计耗时

确认无误后点击 **✅ 开始发送**

### 7. 发送和进度

发送过程中实时显示：
- 进度百分比
- 已处理/总数
- 成功/失败数量
- 当前速度（人/秒）
- 预计剩余时间

### 8. 查看历史

在广播菜单中点击 **📜 历史记录**：
- 查看最近10条广播记录
- 每条显示：标题、目标、人数、成功率、时间
- **含图片标识**：有媒体的广播会显示 📸 含图片
- 点击记录查看详细信息

## 技术细节

### 发送机制

1. **批量处理**：每批25个用户
2. **智能延迟**：批次间延迟0.8-1.2秒（随机）
3. **媒体处理**：
   - 有图片：使用 `send_photo(photo=file_id, caption=text_html)`
   - 无图片：使用 `send_message(text=text_html)`
4. **错误处理**：
   - 捕获 `RetryAfter` 异常并等待
   - 捕获 `BadRequest` 异常（用户屏蔽等）
   - 记录每个用户的发送状态

### 数据库结构

#### broadcasts 表（新增字段）
| 字段 | 类型 | 描述 |
|------|------|------|
| media_type | TEXT | 媒体类型（'none' 或 'photo'） |
| media_ref | TEXT | 媒体引用（photo file_id） |

完整字段：
| 字段 | 类型 | 描述 |
|------|------|------|
| id | INTEGER | 主键 |
| title | TEXT | 标题（默认"广播消息"） |
| content | TEXT | 内容（HTML） |
| buttons_json | TEXT | 按钮JSON |
| target | TEXT | 目标类型 |
| created_by | INTEGER | 创建者ID |
| created_at | TEXT | 创建时间 |
| status | TEXT | 状态 |
| total | INTEGER | 总人数 |
| success | INTEGER | 成功数 |
| failed | INTEGER | 失败数 |
| duration_sec | REAL | 耗时（秒） |
| **media_type** | **TEXT** | **媒体类型** |
| **media_ref** | **TEXT** | **媒体引用** |

### 超时保护

- **超时时间**：5分钟
- **自动清理**：后台线程每分钟检查并清理过期任务
- **清理操作**：删除pending_broadcasts条目，重置用户状态

## 最佳实践

### ✅ 推荐做法

1. **图片优化**：使用清晰但不过大的图片（建议500KB以内）
2. **文本简洁**：保持内容简洁明了
   - 有图片时：caption最多1024字符
   - 无图片时：建议不超过4096字符
3. **按钮精选**：最多3-4个按钮，每个都有明确目的
4. **测试先行**：首次使用时先向小范围群体测试
5. **时机选择**：避免在用户休息时间发送
6. **预览确认**：发送前使用"完整预览"确认效果

### ❌ 避免事项

1. **过长文本**：避免文本过长，影响阅读体验
2. **过多图片**：目前仅支持单图，不要尝试多图
3. **频繁发送**：避免每天发送多次
4. **垃圾信息**：不要发送垃圾广告或无关内容
5. **隐私泄露**：不要在消息中包含敏感信息

## 故障排除

### 问题：发送失败率过高

**可能原因**：
- 大量用户屏蔽了机器人
- 网络连接不稳定
- HTML格式错误
- 图片file_id失效

**解决方案**：
1. 检查HTML格式是否正确
2. 使用"完整预览"测试消息
3. 尝试发送到小范围用户测试
4. 检查网络连接
5. 查看详细日志了解失败原因

### 问题：超时错误

**可能原因**：
- 5分钟内未完成配置

**解决方案**：
1. 准备好内容后再开始
2. 在5分钟内完成配置
3. 可以随时点击"返回"退出，稍后重新开始

### 问题：图片无法上传

**可能原因**：
- 图片格式不支持
- 文件过大
- 以文档方式发送但非image/*类型

**解决方案**：
1. 使用常见图片格式（JPG、PNG）
2. 压缩图片大小
3. 直接粘贴或以"图片"方式发送
4. 不要以"文档"方式发送（除非是image/*）

### 问题：按钮不显示

**可能原因**：
- 按钮格式错误
- 超过4个按钮限制

**解决方案**：
1. 检查格式：`文本|URL` 或 `文本|callback:提示`
2. 确保每行一个按钮
3. 最多添加4个按钮
4. 使用"👀 查看"确认按钮

## 示例场景

### 场景 1：系统维护通知（含图片）

**媒体**：上传系统维护图标

**文本**：
```html
<b>🔧 系统维护通知</b>

系统将于 <b>今晚22:00-24:00</b> 进行维护升级。

维护期间可能出现：
• 暂时无法登录
• 部分功能不可用

感谢您的理解与支持！
```

**按钮**：
```
查看详情|https://example.com/maintenance
```

**目标**：全部用户

### 场景 2：新功能发布（仅文本）

**文本**：
```html
<b>🎉 新功能上线！</b>

我们为您带来了全新功能：
• <b>账号分类</b> - 智能分类管理
• <b>批量操作</b> - 提高效率
• <b>历史记录</b> - 轻松查询

<i>立即体验新功能！</i>
```

**按钮**：
```
立即体验|https://example.com/new-features
使用教程|https://example.com/tutorial
反馈建议|callback:感谢反馈！我们会持续改进
```

**目标**：活跃用户(7天)

### 场景 3：会员优惠（图+文）

**媒体**：上传优惠活动海报

**文本**：
```html
<b>💎 会员专属优惠</b>

感谢您的长期支持！

• 续费 <b>8折</b> 优惠
• 额外赠送 <b>7天</b> 会员时长
• 优先体验新功能

<code>优惠码：VIP2024</code>

活动截止：本月底
```

**按钮**：
```
立即续费|https://example.com/renew
查看特权|https://example.com/vip
```

**目标**：仅会员

## 技术支持

如有问题或建议，请联系管理员或查看项目文档。

---

**版本**：v2.0（新增媒体支持）  
**更新时间**：2025-10-23  
**作者**：TGapibot Development Team
