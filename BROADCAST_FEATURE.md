# 📢 群发通知功能使用指南

## 功能概述

群发通知功能允许管理员向选定的用户群体发送富文本消息，支持自定义按钮、实时进度显示和完整的历史记录跟踪。

## 主要特性

### ✨ 核心功能
- **HTML格式支持**：粗体、斜体、链接、代码等
- **自定义按钮**：URL按钮和回调按钮（最多4个）
- **智能节流**：批量发送（每批25人），延迟0.8-1.2秒
- **实时进度**：显示已处理/总数、成功/失败、速度、预计时间
- **多目标支持**：全部用户、仅会员、活跃用户、新用户
- **完整历史**：记录每次广播的详细信息和成功率

### 🔒 权限要求
- 仅管理员可以访问此功能
- 管理员通过配置文件（ADMIN_IDS）或数据库设置

## 使用流程

### 1. 进入广播菜单

1. 发送 `/start` 命令启动机器人
2. 点击 `👑 管理员面板`
3. 点击 `📢 群发通知`

### 2. 创建新广播（4步向导）

#### 步骤 1：输入标题（必填）
- 标题用于识别此次群发
- 建议不超过80个字符
- 标题不会显示给用户
- **超时时间**：5分钟

示例：
```
双十一促销活动通知
```

#### 步骤 2：输入内容（必填）
- 支持HTML格式标签
- 可以使用以下格式：
  - `<b>粗体</b>`
  - `<i>斜体</i>`
  - `<code>代码</code>`
  - `<a href="URL">链接</a>`
- **超时时间**：5分钟

示例：
```html
<b>🎉 双十一特惠活动开始啦！</b>

尊敬的用户，感谢您的支持！

我们为您准备了以下优惠：
• 会员 <b>5折</b> 优惠
• 新用户 <b>首次免费</b>
• 活动时间：11月11日全天

<i>名额有限，先到先得！</i>
```

#### 步骤 3：添加按钮（可选）
- 每行一个按钮，最多4个
- 支持两种按钮类型：
  1. **URL按钮**：`文本|https://example.com`
  2. **回调按钮**：`文本|callback:提示信息`
- 输入 `跳过` 或 `skip` 可跳过此步骤
- **超时时间**：5分钟

示例：
```
查看详情|https://example.com/promo
立即购买|https://shop.example.com
客服咨询|callback:请联系客服 @support
```

#### 步骤 4：选择目标用户
选择要发送通知的用户群体：

| 选项 | 描述 | 筛选条件 |
|------|------|----------|
| 👥 全部用户 | 所有注册用户 | 无限制 |
| 💎 仅会员 | 有效会员用户 | 会员未过期 |
| 🔥 活跃用户(7天) | 近期活跃用户 | 7天内有活动 |
| 🆕 新用户(7天) | 新注册用户 | 7天内注册 |

系统会显示每个选项的用户数量，帮助您做出选择。

### 3. 预览和确认

选择目标后，系统会显示预览：
- 标题
- 目标群体和人数
- 内容预览（前200字符）
- 按钮列表
- 预计耗时

确认无误后点击 `✅ 开始发送`

### 4. 发送和进度

发送过程中，系统会实时显示：
- 进度百分比
- 已处理/总数
- 成功/失败数量
- 当前速度（人/秒）
- 预计剩余时间

### 5. 查看历史

在广播菜单中点击 `📜 历史记录`：
- 查看最近10条广播记录
- 每条记录显示标题、目标、人数、成功率、时间
- 点击记录可查看详细信息

## 技术细节

### 发送机制

1. **批量处理**：每批25个用户
2. **智能延迟**：批次间延迟0.8-1.2秒（随机）
3. **错误处理**：
   - 捕获 `RetryAfter` 异常并等待
   - 捕获 `BadRequest` 异常（用户屏蔽等）
   - 记录每个用户的发送状态

### 数据库结构

#### broadcasts 表
| 字段 | 类型 | 描述 |
|------|------|------|
| id | INTEGER | 主键 |
| title | TEXT | 标题 |
| content | TEXT | 内容 |
| buttons_json | TEXT | 按钮JSON |
| target | TEXT | 目标类型 |
| created_by | INTEGER | 创建者ID |
| created_at | TEXT | 创建时间 |
| status | TEXT | 状态（pending/completed/failed） |
| total | INTEGER | 总人数 |
| success | INTEGER | 成功数 |
| failed | INTEGER | 失败数 |
| duration_sec | REAL | 耗时（秒） |

#### broadcast_logs 表
| 字段 | 类型 | 描述 |
|------|------|------|
| id | INTEGER | 主键 |
| broadcast_id | INTEGER | 广播ID |
| user_id | INTEGER | 用户ID |
| status | TEXT | 状态（success/failed/blocked） |
| error | TEXT | 错误信息 |
| sent_at | TEXT | 发送时间 |

## 最佳实践

### ✅ 推荐做法

1. **测试先行**：首次使用时，先向"新用户(7天)"或小范围群体测试
2. **内容简洁**：保持内容简洁明了，避免过长
3. **按钮精选**：最多使用3-4个按钮，确保每个按钮都有明确目的
4. **时机选择**：避免在用户休息时间发送
5. **频率控制**：避免频繁发送，建议每周不超过2-3次

### ❌ 避免事项

1. **垃圾信息**：不要发送垃圾广告或无关内容
2. **过度频繁**：避免每天发送多次
3. **强制操作**：不要在消息中要求用户必须执行某些操作
4. **误导信息**：确保消息内容真实准确
5. **隐私泄露**：不要在消息中包含敏感信息

## 故障排除

### 问题：发送失败率过高

**可能原因**：
- 大量用户屏蔽了机器人
- 网络连接不稳定
- HTML格式错误

**解决方案**：
1. 检查HTML格式是否正确
2. 尝试发送到小范围用户测试
3. 检查网络连接
4. 查看详细日志了解失败原因

### 问题：超时错误

**可能原因**：
- 5分钟内未完成某个步骤
- 任务被系统清理

**解决方案**：
1. 重新开始广播创建流程
2. 准备好内容后再开始
3. 确保在5分钟内完成每个步骤

### 问题：按钮不显示

**可能原因**：
- 按钮格式错误
- 超过4个按钮限制

**解决方案**：
1. 检查按钮格式：`文本|URL` 或 `文本|callback:提示`
2. 确保每行一个按钮
3. 最多添加4个按钮

## 示例场景

### 场景 1：系统维护通知

**目标**：全部用户

**内容**：
```html
<b>🔧 系统维护通知</b>

尊敬的用户：

系统将于 <b>今晚22:00-24:00</b> 进行维护升级。

维护期间可能出现：
• 暂时无法登录
• 部分功能不可用

感谢您的理解与支持！
```

**按钮**：
```
查看详情|https://example.com/maintenance
```

### 场景 2：新功能发布

**目标**：活跃用户(7天)

**内容**：
```html
<b>🎉 新功能上线！</b>

我们为您带来了全新功能：
• <b>账号分类</b> - 智能分类管理
• <b>批量操作</b> - 提高效率
• <b>历史记录</b> - 轻松查询

<i>立即体验新功能！</i>
```

**按钮**：
```
立即体验|https://example.com/new-features
使用教程|https://example.com/tutorial
反馈建议|callback:感谢您的反馈！我们会持续改进
```

### 场景 3：会员优惠

**目标**：仅会员

**内容**：
```html
<b>💎 会员专属优惠</b>

尊贵的会员用户：

感谢您的长期支持！我们为您准备了：
• 续费 <b>8折</b> 优惠
• 额外赠送 <b>7天</b> 会员时长
• 优先体验新功能

<code>优惠码：VIP2024</code>

活动截止：本月底
```

**按钮**：
```
立即续费|https://example.com/renew
查看特权|https://example.com/vip
```

## 技术支持

如有问题或建议，请联系管理员或查看项目文档。

---

**版本**：v1.0  
**更新时间**：2025-10-23  
**作者**：TGapibot Development Team
